# ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° êµ¬í˜„(feat. Nginx Rtmp)

### ìŠ¤íŠ¸ë¦¬ë° í”„ë¡œí† ì½œ ë¹„êµ <a href="#undefined" id="undefined"></a>

***

### RTMP <a href="#rtmp" id="rtmp"></a>

![](https://velog.velcdn.com/images/van1164/post/835824c8-e698-4c01-9bac-6baa180cfab5/image.png)

> ìŠ¤íŠ¸ë¦¬ë° ì„œë²„ì™€ **Adobe Flash Player** ê°„ì— ì˜¤ë””ì˜¤ ë° ë¹„ë””ì˜¤ íŒŒì¼ì„ ì „ì†¡í•˜ê¸° ìœ„í•´ **Adobe**ì—ì„œ ê°œë°œí•œ ë ˆê±°ì‹œ í”„ë¡œí† ì½œ

#### ì¥ì  <a href="#undefined" id="undefined"></a>

**1. ì§§ì€ ì§€ì—°ì‹œê°„**

**2. ë§ì€ ì„œë¹„ìŠ¤ì—ì„œ ì‚¬ìš©í•˜ê³  ìˆê¸°ë•Œë¬¸ì— Nginx Rtmpì™€ ê°™ì€ í™œìš©ê°€ëŠ¥í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì¡´ì¬**

**3. ë¹¨ë¦¬ ê°ê¸° ë° ë˜ê°ê¸° ê°€ëŠ¥**

#### ë‹¨ì  <a href="#undefined" id="undefined"></a>

**1. ì§€ì—°ì‹œê°„ì´ ì¡´ì¬**

***

### WebRTC <a href="#webrtc" id="webrtc"></a>

![](https://velog.velcdn.com/images/van1164/post/f98dd18a-91e2-45ff-9e97-07f1f533df39/image.png)

> **WebRTC**(Web Real-Time Communication)ëŠ” ì›¹ ë¸Œë¼ìš°ì € ê°„ì— í”ŒëŸ¬ê·¸ì¸ì˜ ë„ì›€ ì—†ì´ ì„œë¡œ í†µì‹ í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ëœ APIì´ë‹¤. ìŒì„± í†µí™”, ì˜ìƒ í†µí™”, P2P íŒŒì¼ ê³µìœ  ë“±ìœ¼ë¡œ í™œìš©ë  ìˆ˜ ìˆë‹¤.

#### ì¥ì  <a href="#id-1" id="id-1"></a>

**1. ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë‹¤ìˆ˜ ì¡´ì¬í•˜ì—¬ ê°œë°œì— ìš©ì´**

**2. ì§€ì—°ì‹œê°„ì´ ê±°ì˜ ì—†ëŠ” ì‹¤ì‹œê°„ì„±**

#### ë‹¨ì  <a href="#id-1" id="id-1"></a>

**1. ë‹¤ë¥¸ í”„ë¡œí† ì½œì— ë¹„í•´ ë§ì€ ì‚¬ìš©ìë¥¼ ë°›ê¸° ì–´ë ¤ì›€**

***

### SRT <a href="#srt" id="srt"></a>

![](https://velog.velcdn.com/images/van1164/post/82589894-7652-4738-9faf-0f8314ba3d27/image.jpg)

> **SRT**ëŠ” Haivisionì´ ê°œë°œí•œ ì˜¤í”ˆ ì†ŒìŠ¤ ë¹„ë””ì˜¤ ì „ì†¡ í”„ë¡œí† ì½œë¡œ, ê³µìš© ì¸í„°ë„·ì„ í¬í•¨í•œ ë‹¤ì–‘í•œ ë„¤íŠ¸ì›Œí¬ì—ì„œ ì§€ì—° ì‹œê°„ì´ ì§§ì€ ë¹„ë””ì˜¤ ë° ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ì„ ì œê³µí•˜ê¸° ìœ„í•´ ë‘ ê°œì˜ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì—°ê²°í•˜ë„ë¡ ì„¤ê³„ë˜ì—ˆë‹¤.

#### ì¥ì  <a href="#id-2" id="id-2"></a>

**1. ë‹¤ë¥¸ í”„ë¡œí† ì½œì— ë¹„í•´ ë³´ì•ˆì´ ë†’ìŒ**

**2. ëŒ€ë¶€ë¶„ì˜ ì¥ì¹˜ì—ì„œ í˜¸í™˜ì´ ê°€ëŠ¥í•¨**

**3. ë‚®ì€ ëŒ€ê¸°ì‹œê°„**

#### ë‹¨ì  <a href="#id-2" id="id-2"></a>

**1. ë‹¤ë¥¸ í”„ë¡œí† ì½œì— ë¹„í•´ ê°œë°œì •ë³´ê°€ ë¶€ì¡±í•¨**

***

### í”„ë¡œí† ì½œì˜ ì„ íƒ <a href="#undefined" id="undefined"></a>

ìŠ¤íŠ¸ë¦¬ë¨¸ì˜ ë°©ì†¡ì„ ë‹¤ìˆ˜ì˜ ì´ìš©ìê°€ ì‹œì²­ì„ í•˜ê³  ì‹œì²­í•´ì•¼í•˜ê¸° ë•Œë¬¸ì— **`WebRTC`** ëŠ” ì ë‹¹í•˜ì§€ ì•Šë‹¤ê³  ìƒê°í–ˆë‹¤. ê·¸ë˜ì„œ **`RTMP`**&#xC640; **`SRT`**&#xB97C; ê³ ë ¤í•´ë³´ì•˜ëŠ”ë°, **`SRT`**&#xC758; ì •ì ì´ **`RTMP`**&#xC5D0; ë¹„í•´ ì¢‹ì•„ë³´ì´ì§€ë§Œ, ì •ë³´ê°€ ë§ì§€ ì•Šì•„ì„œ **`RTMP`**&#xB85C; êµ¬í˜„í•˜ê³  ì¶”í›„ì— **`SRT`**&#xB97C; ê³ ë ¤í•´ë³´ëŠ” ê²ƒìœ¼ë¡œ ìƒê°í–ˆë‹¤.

***

### Nginx Rtmp <a href="#nginx-rtmp" id="nginx-rtmp"></a>

![](https://velog.velcdn.com/images/van1164/post/407d1efb-f691-4522-98b3-ac1864157aba/image.jpg)

#### nginx.conf íŒŒì¼ êµ¬ì„± <a href="#nginxconf" id="nginxconf"></a>

```nginx
user root;
worker_processes auto;

events {
	worker_connections 768;
}
 
rtmp {
    server {
    # rtmp í¬íŠ¸ ë²ˆí˜¸
        listen 1935;
        listen [::]:1935 ipv6only=on;

        chunk_size 4096;

        application live {
            live on;
            record off;

            #HLSë¡œ ì €ì¥
            hls on;
            hls_path /tmp/hls;
            hls_fragment 3;
            hls_playlist_length 60m;
			
            # ì„ì‹œíŒŒì¼
			dash on;
            dash_path /tmp/dash;
        }
    }
}
```

**ì„¤ì • ë³€ìˆ˜ë“¤ ì°¸ê³ **

[https://github.com/arut/nginx-rtmp-module/wiki/Directives](https://github.com/arut/nginx-rtmp-module/wiki/Directives)

#### nginx-rtmp ëª¨ë“ˆì„ ì„¤ì¹˜í•œ nginx dockerfile <a href="#nginx-rtmp-nginx-dockerfile" id="nginx-rtmp-nginx-dockerfile"></a>

```docker
FROM alpine:3.13.4 as builder

RUN apk add --update build-base git bash gcc make g++ zlib-dev linux-headers pcre-dev openssl-dev

# nginx, nginx-rtmp-module ë‹¤ìš´
RUN git clone https://github.com/arut/nginx-rtmp-module.git && \
    git clone https://github.com/nginx/nginx.git

# nginxë¥¼ ì„¤ì¹˜í•˜ê³  nginx-rtmp-module ì¶”ê°€
RUN cd nginx && ./auto/configure --add-module=../nginx-rtmp-module && make && make install

FROM alpine:3.13.4 as nginx

# ffmpeg ì„¤ì¹˜
RUN apk add --update pcre ffmpeg

# ë¹Œë“œëœ íŒŒì¼ ë° ì„¤ì •íŒŒì¼ ë³µì‚¬
COPY --from=builder /usr/local/nginx /usr/local/nginx
COPY nginx.conf /usr/local/nginx/conf/nginx.conf

# ì‹¤í–‰
ENTRYPOINT ["/usr/local/nginx/sbin/nginx"]
CMD ["-g", "daemon off;"]
```

[https://github.com/arut/nginx-rtmp-module](https://github.com/arut/nginx-rtmp-module)

#### ì´ë ‡ê²Œ ì‹¤í–‰í•˜ê³  OBSë¥¼ í†µí•´ rtmpì„œë²„ ì„¤ì • í›„ ë°©ì†¡ì„ ì‹œì‘í•˜ë©´ <a href="#obs-rtmp" id="obs-rtmp"></a>

![](https://velog.velcdn.com/images/van1164/post/019224e8-d86b-4e1d-bd99-8e5700d2c30f/image.png)

#### ì•„ë˜ì™€ ê°™ì´ ë°©ì†¡ íŒŒì¼ë“¤ì´ tsíŒŒì¼ë“¤ë¡œ ë‚˜ë‰˜ì–´ ì €ì¥ëœë‹¤. <a href="#ts" id="ts"></a>

![](https://velog.velcdn.com/images/van1164/post/d62e3373-acb7-4acf-89b1-0896782964e1/image.png)

***

### m3u8 ì ‘ì† <a href="#m3u8" id="m3u8"></a>

#### nginx ì„¤ì • íŒŒì¼ ì¶”ê°€ <a href="#nginx" id="nginx"></a>

```
http {
    server {
        listen 8088;

        root /tmp;

        location /hls {
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Content-Type' 'application/json' always;

            types {
                 application/vnd.apple.mpegurl m3u8;
                 video/mp2t ts;
            }
        }
    }
}
```

#### ì‹¤ì‹œê°„ ì¬ìƒ <a href="#undefined" id="undefined"></a>

![](https://velog.velcdn.com/images/van1164/post/25ef3a56-4893-4cb8-b289-002bf8adaa54/image.png)

***

### ë™ì˜ìƒ ì €ì¥ì—ì„œ ìƒê¸´ ë¬¸ì œ <a href="#undefined" id="undefined"></a>

rtmpë¡œ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°›ì€ ì˜ìƒì„ ë¡œì»¬ì„œë²„ì— ì €ì¥í•˜ëŠ” ê²ƒì€ ìš©ëŸ‰ì— í° ë¬¸ì œê°€ ìƒê¸¸ ë¿ì•„ë‹ˆë¼, ë™ì˜ìƒì— ëŒ€í•œ ì •ë³´ë¥¼ ìš°ë¦¬ì˜ ì„œë²„ì—ë„ ê¸°ë¡ì„ í•´ì•¼ ì„œë¹„ìŠ¤ê°€ ì›í• í•˜ê²Œ êµ¬í˜„ë  ê²ƒì´ë¼ê³  ìƒê°í–ˆë‹¤.\
í•˜ì§€ë§Œ, ì„œë²„ë‚˜ S3ì— ë™ì˜ìƒì„ ì €ì¥í•˜ëŠ” ë°©ë²•ì„ ì—¬ëŸ¬ê°€ì§€ ì‹œë„í•˜ì˜€ìœ¼ë‚˜ ëª¨ë‘ ì‹¤íŒ¨í–ˆë‹¤.

#### ì‹¤íŒ¨ 1. rtmp ìŠ¤íŠ¸ë¦¼ì„ httpë¥¼ í†µí•´ ì„œë²„ë¡œ ì „ì†¡ <a href="#id-1-rtmp-http" id="id-1-rtmp-http"></a>

ì •ë§ ë‹¤ì–‘í•œ ë°©ë²•ì„ í†µí•´ httpë¥¼ í†µí•´ ìš°ë¦¬ ì„œë²„ë¡œ ìŠ¤íŠ¸ë¦¼ì„ ì „ì†¡í•˜ê³  ë‚´ë¶€ì—ì„œ ì²˜ë¦¬í•˜ê³ ì í•˜ì˜€ìœ¼ë‚˜ rtmpë¥¼ httpë¡œ ì „ì†¡í•˜ëŠ” ë°©ë²•ì´ ì¡´ì¬í•˜ì§€ ì•Šì•˜ë‹¤.(ë‚´ê°€ ëª»ì°¾ì€ ê²ƒì¼ìˆ˜ë„..)

#### ì‹¤íŒ¨ 2. hls í´ë”ì— ìƒì„±ëœ tsíŒŒì¼ì„ ì½ì–´ì™€ì„œ s3ì— ì—…ë¡œë“œ <a href="#id-2-hls-ts-s3" id="id-2-hls-ts-s3"></a>

hlsí´ë”ì— ë³€í™”ë¥¼ ê°ì§€í•´ì„œ ë³€í™”ê°€ ìƒê¸°ë©´ íŒŒì¼ë“¤ì„ s3ì— ì—…ë¡œë“œë¥¼ êµ¬í˜„í•˜ë ¤í–ˆìœ¼ë‚˜ tsíŒŒì¼ì€ í•œë²ˆì— ì‘ì„±ë˜ì§€ì•Šê³  ê³„ì†í•´ì„œ ì—…ë°ì´íŠ¸ ë˜ê¸° ë•Œë¬¸ì— ì‹¤íŒ¨í–ˆë‹¤.

#### ì‹¤íŒ¨ 3. RTMPì— ëŒ€í•œ Listenì„ ì„œë²„ì—ì„œ í•˜ë„ë¡ êµ¬í˜„ <a href="#id-3-rtmp-listen" id="id-3-rtmp-listen"></a>

`ffmpeg -listen 1` ëª…ë ¹ì„ í†µí•´ rtmpì‘ë‹µì„ ì§ì ‘ ë°›ì•„ì˜¤ëŠ” ê²ƒì´ ê°€ëŠ¥í–ˆì§€ë§Œ stream keyê°€ ì •í™•í•˜ì§€ ì•Šì•„ë„ ë°›ì•„ì˜¤ëŠ” ë¬¸ì œê°€ ìˆì—ˆê³ , ë§ì€ ì •ë³´ì¡°ì‚¬ë¥¼ í–ˆì§€ë§Œ ì´ë¥¼ ffmpegë‚´ì—ì„œ í•´ê²°ì€ ë¶ˆê°€ëŠ¥í–ˆë‹¤.

**ê·¸ë˜ì„œ ìµœì¢…ì ì¸ ë°©ë²•ì€ nginx-rtmpì™€ ì„œë²„ë¥¼ ë™ì‹œì— ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì„ ì±„íƒí•˜ì˜€ë‹¤. nginx-rtmpì™€ ìš°ë¦¬ ì„œë²„ê°€ ê°ê° ë™ì‘í•˜ì§€ë§Œ ìŠ¤íŠ¸ë¦¬ë° íŒŒì¼ì— ëŒ€í•œ ë””ë ‰í† ë¦¬ë¥¼ ê³µìœ í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„í•˜ì˜€ë‹¤.**

**docker compose**

```yaml
version: '1'
services:
  spring-app:
    image: van133/streaming:latest
    container_name: streaming
    ports:
      - "8080:8080"
    volumes:
      - tmp:/tmp
#    restart: unless-stopped


  mysql:
    image: mysql:latest
    container_name: db-mysql
    ports:
      - "3306:3306"
#    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ttink1245!
      TZ: Asia/Seoul

  nginx-rtmp:
    image: van133/nginx-rtmp
    ports:
      - "1935:1935"
    volumes:
      - tmp:/tmp

volumes:
  tmp:
```

tmp í´ë”ë¥¼ ê³µìœ  volumeìœ¼ë¡œ ì§€ì •í•´ì„œ ìš°ë¦¬ì˜ ì„œë²„ì—ì„œ rtmpë¡œ ë“¤ì–´ì˜¨ íŒŒì¼ë“¤ì„ ì²´í¬í•  ìˆ˜ìˆê²Œ êµ¬ì„±í•˜ì˜€ë‹¤. ê·¸ í›„ 10ë¶„ê°„ ìœ íš¨í•œ stream keyì— ëŒ€í•´ì„œ m3u8 ì¸ë±ìŠ¤ íŒŒì¼ì´ ìƒê¸°ë©´ ì´ë²¤íŠ¸ë¥¼ ë°©ìƒì‹œí‚¤ëŠ” ë™ì‘ì„ êµ¬í˜„í•˜ì˜€ë‹¤.

```kotlin
private fun checkStreamStart(m3u8Path: Path): Flux<Boolean> {
    return Flux.interval(Duration.ofSeconds(1))
        .take(600)
        .map {
            logger.info { m3u8Path }
            if (m3u8Path.exists()) {
                sink.tryEmitNext(Event("finish", "finish"))
                return@map true
            }
            else{
                return@map false
            }
        }
        .takeUntil{it == true}
}
```

### ê²°ê³¼ <a href="#undefined" id="undefined"></a>

![](https://velog.velcdn.com/images/van1164/post/d976db78-21c3-4b82-810e-ca51ef151886/image.gif)

> ì™€.. ì´ë²ˆ êµ¬í˜„ì€ `ffmpeg`,`rtmp`, `nginx`, `docker` ë“±ë“± ë°°ê²½ì§€ì‹ì„ ë§¤ìš° ë§ì´ í•„ìš”ë¡œ í–ˆë˜ ê²ƒê°™ë‹¤. ì´ í¬ìŠ¤íŒ…ì—ëŠ” ëª¨ë“  ë‚´ìš©ì„ ë‹´ì§€ ëª»í–ˆì§€ë§Œ, ìˆ˜ ë§ì€ ì‹œë„ë¥¼ í–ˆê³  ì •ë§ í˜ë“¤ì—ˆë‹¤.
>
> ê·¸ëƒ¥ ë¼ì´ë¸Œ ìŠ¤íŠ¸ë¦¬ë°ë§Œì„ ëª©í‘œë¡œ í•œë‹¤ë©´, nginx-rtmpë§Œìœ¼ë¡œë„ ê°€ëŠ¥í•˜ê² ì§€ë§Œ, ì•ì˜ ì¥ë©´ìœ¼ë¡œë„ ëŒì•„ê°ˆ ìˆ˜ìˆê³  ìŠ¤íŠ¸ë¦¬ë¨¸ê°€ ì›í•œë‹¤ë©´ ì €ì¥í•  ìˆ˜ë„ ìˆëŠ” ì„œë¹„ìŠ¤ê°€ ëª©í‘œì´ê¸° ë•Œë¬¸ì— ì¡°ê¸ˆ ë” ë³µì¡í–ˆë˜ ê²ƒ ê°™ë‹¤.í•˜ì§€ë§Œ ê·¸ë§Œí¼ ìŠ¤íŠ¸ë¦¬ë°ê³¼ rtmpí”„ë¡œí† ì½œì— ëŒ€í•´ ê¹Šê²Œ ê³µë¶€í•  ìˆ˜ ìˆì—ˆë‹¤.

### ğŸ˜‹ ì°¸ê³  <a href="#undefined" id="undefined"></a>

[https://getstream.io/blog/streaming-protocols/](https://getstream.io/blog/streaming-protocols/)\
[https://corp.kaltura.com/blog/rtmp-server-guide/](https://corp.kaltura.com/blog/rtmp-server-guide/)\
[https://velog.io/@highway92/RTMP-%EC%99%80-WebRTC-%EB%B9%84%EA%B5%90](https://velog.io/@highway92/RTMP-%EC%99%80-WebRTC-%EB%B9%84%EA%B5%90)\
[https://velog.io/@happyjarban/WebRTC-%ED%8C%8C%ED%97%A4%EC%B9%98%EA%B8%B01-WebRTC-%EC%9D%B4%EB%A1%A0](https://velog.io/@happyjarban/WebRTC-%ED%8C%8C%ED%97%A4%EC%B9%98%EA%B8%B01-WebRTC-%EC%9D%B4%EB%A1%A0)\
[https://github.com/arut/nginx-rtmp-module/wiki/Directives](https://github.com/arut/nginx-rtmp-module/wiki/Directives)\
[https://qteveryday.tistory.com/371](https://qteveryday.tistory.com/371)\
[https://github.com/arut/nginx-rtmp-module/wiki/Directives](https://github.com/arut/nginx-rtmp-module/wiki/Directives)\
[https://ffmpeg.org/ffmpeg.html](https://ffmpeg.org/ffmpeg.html)
