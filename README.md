# Kopring
![image](https://github.com/van1164/kopring/assets/52437971/8403ddda-5f72-4df8-9f5d-69cc6aa02b70)


## ëª©ì°¨

### 1. [WebFlux](https://github.com/van1164/kopring/blob/main/webflux/1.%20%EB%8F%99%EA%B8%B0%EC%99%80%20%EB%B9%84%EB%8F%99%EA%B8%B0%20%26%20Blocking%EA%B3%BC%20Non-Blocking.md)
### 2. [R2DBC](#r2dbc)
### 3. [JPA](#jpa)
### 4. [Redis](#redis)
### 5. [Spring Security](#spring-security)
### 6. [Spring Batch](#spring-batch)
### 7. [Kafka](#kafka)
### 8. [AWS](#aws)
### 9. [Elastic Search](#elastic-search)
### 10. [JUNIT](#junit)
### 11. [ERROR](#error)

---

# ê¸°íƒ€ í”„ë¡œì íŠ¸ ë° í•™ìŠµ
## ğŸ€ spring-webflux

* [Webflux í™˜ê²½ì—ì„œ MultiPartë¡œ íŒŒì¼ ì—…ë¡œë“œ (feat. S3 ì—…ë¡œë“œí•˜ëŠ” ë²•ê¹Œì§€)](spring-webflux/webflux-multipart-feat.-s3.md)
* [R2DBC ì •ë¦¬](spring-webflux/reactor-feat.-r2dbc.md)
* [Webfluxì—ì„œ @Transactionalì´ Rollbackì„ ì•ˆí•´ìš”...](spring-webflux/webflux-transactional-rollback-....md)

## â™»ï¸ ë¦¬ì•¡í‹°ë¸Œ í”„ë¡œê·¸ë˜ë° <a href="#reacitve-programming" id="reacitve-programming"></a>

* [ë™ê¸° vs ë¹„ë™ê¸°, Blocking vs Non-Blocking](<README (1).md>)
* [Executor Serviceì™€ Future, ê·¸ë¦¬ê³  CompletableFuture](reacitve-programming/executor-service-future-completablefuture.md)
* [Cold Sequenceì™€ Hot Sequence](reacitve-programming/cold-sequence-hot-sequence.md)
* [Reactive Manifesto](reacitve-programming/reactive-manifesto.md)
* [Publisherì™€ Subscriber](reacitve-programming/publisher-subscriber.md)
* [Schedulerì™€ publishOn& subscribeOn](reacitve-programming/scheduler-publishon-and-subscribeon.md)
* [switchIfEmpty ì™€ defaultIfEmpty ì°¨ì´](reacitve-programming/switchifempty-defaultifempty.md)

## ë™ì˜ìƒ ìŠ¤íŠ¸ë¦¬ë° í”„ë¡œì íŠ¸ <a href="#project-video-streaming" id="project-video-streaming"></a>

* [FFmpeg í•™ìŠµ](project-video-streaming/ffmpeg.md)
* [Chunkë¡œ ë‚˜ëˆ ì„œ ì—…ë¡œë“œ](project-video-streaming/chunk.md)
* [HLS(Http Live Streaming) ì ìš©ê¸°](project-video-streaming/hls-http-live-streaming.md)
* [ì¸ë„¤ì¼ ë§Œë“¤ê¸°](project-video-streaming/undefined.md)
* [ì—…ë¡œë“œ ì‹œê°„ ì´ê²Œ ìµœì„ ì¼ê¹Œ? (feat.ë¹„ë™ê¸° Non-Blocking)](project-video-streaming/feat.-non-blocking.md)
* [ë¶€í•˜ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³´ì (feat. nGrinder)](project-video-streaming/feat.-ngrinder.md)
* [WebFluxì ìš©ê¸° (feat. Server Sent Event)](project-video-streaming/webflux-feat.-server-sent-event.md)
* [ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° êµ¬í˜„(feat. Nginx Rtmp)](project-video-streaming/feat.-nginx-rtmp.md)
* [JPAì—ì„œ R2DBCë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜](project-video-streaming/jpa-r2dbc.md)
* [ë©€í‹°ëª¨ë“ˆ ì ìš©ê¸°](project-video-streaming/undefined-1.md)
* [ë°°í¬í•˜ë©´ì„œ ë°œìƒí•œ ë¬¸ì œë“¤](project-video-streaming/undefined-2.md)
* [ëŒ“ê¸€ê¸°ëŠ¥ êµ¬í˜„](project-video-streaming/undefined-3.md)
* [ëŒ“ê¸€ ì¢‹ì•„ìš” êµ¬í˜„ (feat. ë™ì‹œì„± ë¬¸ì œ)](project-video-streaming/feat..md)
* [ì¢‹ì•„ìš”, ì¡°íšŒìˆ˜ ê¸°ëŠ¥ ìµœì í™” (feat. Redis + AWS Lambda)](project-video-streaming/feat.-redis-+-aws-lambda.md)

## Spring

* [ë¹ˆ ìŠ¤ì½”í”„ì— ëŒ€í•´ì„œ](spring/undefined.md)
* [@Validatedì™€ @Validë¥¼ í†µí•œ ìœ íš¨ì„±ê²€ì‚¬](spring/validated-valid.md)
* [bindingResultë¡œ ì˜ˆì™¸ í™•ì¸](spring/bindingresult.md)
* [@NotNull, @NotEmpty, @NotBlank á„‹á…´ á„á…¡á„‹á…µá„Œá…¥á†·](spring/notnull-notempty-notblank.md)

## Spring-Jpa

* [N+1ë¬¸ì œì— ëŒ€í•œ ìƒê°](spring-jpa/n+1.md)
* [@Transactionalì˜ ë‚´ë¶€ ë™ì‘ ê³¼ì •](spring-jpa/transactional.md)
* [@Transactionalì—ì„œ readOnly = trueë¥¼ í•˜ë©´ ë¬´ìŠ¨ ì¼ì´ ë²Œì–´ì§ˆê¹Œ](spring-jpa/transactional-readonly-true.md)
* [ë°ì´í„°ë² ì´ìŠ¤ ê²©ë¦¬ìˆ˜ì¤€ê³¼ ë™ì‹œì„±(feat. Lockingê³¼ MVCC ê°ê° ê´€ì ì—ì„œ)](spring-jpa/feat.-locking-mvcc.md)
* [Spring ì½”ë“œì—ì„œì˜ íŠ¸ëœì­ì…˜ê³¼ DBì—ì„œì˜ íŠ¸ëœì­ì…˜](spring-jpa/spring-db.md)
* [JPA í˜ì´ì§€ë„¤ì´ì…˜ ìµœì í™” (Offset, Cusor, ì»¤ë²„ë§ ì¸ë±ìŠ¤)](spring-jpa/jpa-offset-cusor.md)

## SPRING-SECURITY-REACTIVE

* [Webfluxí™˜ê²½ì—ì„œ JWT ì‚¬ìš©í•˜ê¸°](spring-security-reactive/webflux-jwt.md)
* [@AuthenticationPrincipalì— nullê°’ ë“¤ì–´ì˜¤ëŠ” ë¬¸ì œ](spring-security-reactive/authenticationprincipal-null.md)

## redis

* [ì¢‹ì•„ìš” ê¸°ëŠ¥ ìµœì í™” (feat. redis)](redis/feat.-redis.md)
* [Redis Lua Scriptë¥¼ í™œìš©í•´ì„œ ì£¼ë¬¸ ê¸°ëŠ¥ ì›ìì„± ë³´ì¥](redis/redis-lua-script.md)

## ğŸ“— í† ë¹„ì˜ ìŠ¤í”„ë§ <a href="#tobi-spring" id="tobi-spring"></a>

* [í† ë¹„ì˜ ìŠ¤í”„ë§ 1ì¥](tobi-spring/1.md)
* [í† ë¹„ì˜ ìŠ¤í”„ë§ 2ì¥](tobi-spring/2.md)
* [í† ë¹„ì˜ ìŠ¤í”„ë§ 3ì¥](tobi-spring/3.md)
* [í† ë¹„ì˜ ìŠ¤í”„ë§ 4ì¥](tobi-spring/4.md)
* [í† ë¹„ì˜ ìŠ¤í”„ë§ 5ì¥](tobi-spring/5.md)

## TDD

* [Fixture Monkey ì ìš©ê¸°](tdd/fixture-monkey.md)
* [JUnitìœ¼ë¡œ ë™ì‹œì„±ë¬¸ì œë¥¼ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆê²Œ í•´ë³´ì! (ë¼ì´ë¸ŒëŸ¬ë¦¬ ê°œë°œê¸°)](tdd/junit.md)

## ğŸ¨ Design-Pattern

* [ì‹±ê¸€í†¤ íŒ¨í„´](design-pattern/undefined.md)
* [íŒ©í† ë¦¬ íŒ¨í„´](design-pattern/undefined-1.md)
* [ì „ëµ íŒ¨í„´](design-pattern/undefined-2.md)
* [ì˜µì €ë²„ íŒ¨í„´](design-pattern/undefined-3.md)



# R2DBC

## R2DBCë€?
> Reactive Relational DataBase Connectivity (R2DBC) ëŠ” JPA,JDBCë“±ìœ¼ë¡œ ì‚¬ìš©í•˜ë˜ Blocking ê¸°ë°˜ RDBë¥¼ Reactive í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ API ë¥¼ ì œê³µí•œë‹¤. WebFlux ì™€ R2DBC ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš° ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì˜¨ì „íˆ Reactive í•˜ê²Œ ë™ì‘í•  ìˆ˜ ìˆë„ë¡ ì§€ì›í•œë‹¤.

### JDBC, JPA
`JDBC`ëŠ” ë™ê¸° **Blocking I/O** ê¸°ë°˜ìœ¼ë¡œ ì„¤ê³„ëœ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ë¼ì´ë¸ŒëŸ¬ë¦¬ì´ë‹¤.
`JPA`ëŠ” `JDBC`ë¥¼ ì‚¬ìš©í•´ì„œ ë°ì´í„°ë² ì´ìŠ¤ì™€ ê°ì²´ë¥¼ ì˜ ë§¤í•‘í•´ì£¼ëŠ” ê¸°ìˆ ë¡œ **Blocking I/O**ê¸°ë°˜ì„ì€ ë˜‘ê°™ë‹¤.

ì´ëŸ¬í•œ ì´ìœ ë¡œ WebFLuxì™€ ê°™ì´** Non-Blocking** Reactive í™˜ê²½ì—ì„œ ì‚¬ìš©í•˜ê²Œ ë˜ë©´ Blockingë˜ëŠ” í˜„ìƒì´ ë°œìƒí•œë‹¤.

## R2DBC
### R2dbc SPI(Service Provider Interface)
#### ë‹¤ìŒê³¼ ê°™ì€ ì¸í„°í˜ì´ìŠ¤ë“¤ ì œê³µ
1. ì—°ê²° (Connection Factory ë“±ë“±)
2. ì—ëŸ¬ í•¸ë“¤ë§
3. transaction ê´€ë ¨ ê¸°ëŠ¥

#### êµ¬ë¬¸
**`bind`**: sqlì— íŒŒë¼ë¯¸í„°ë¥¼ bindingí•˜ëŠ” êµ¬ë¬¸
**`add`** : ì´ì „ ê¹Œì§€ì˜ bindingì„ ì €ì¥ í›„ ìƒˆë¡œìš´ bindingìƒì„±
**`execute`** : ìƒì„±ëœ bindingë§Œí¼ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰ í›„ ê²°ê³¼ë¥¼ Publisher í˜•íƒœë¡œ ì œê³µ

## R2DBC MySql
### Connection
#### MySqlConnectionFactory
`MySqlConnection` ê°ì²´ë¥¼ `Mono`í˜•íƒœë¡œ ê°€ì§€ê³  ìˆìŒ. 
ì‹±ê¸€í†¤ íŒ¨í„´ìœ¼ë¡œ êµ¬í˜„ë˜ì–´ ìˆìŒ.
#### MySqlConnectionConfiguration
MySQL ì—°ê²° ì„¤ì •ì„ í¬í•¨í•˜ëŠ” ê°ì²´ 
host, port, database, username, passwordë“±ì˜ ê¸°ë³¸ ì„¤ì •ì„ ì œê³µ

``` kotlin
var connectionFactory = MySqlConnectionFactory.from(config);
```

### Client

#### R2dbcEntityTemplete
spring data r2dbcì˜ ì¶”ìƒí™” í´ë˜ìŠ¤ 
ê²°ê³¼ë¥¼ entityê°ì²´ë¡œ ë°›ì„ ìˆ˜ ìˆìŒ.
```kotlin
var template = new R2dbcEntityTemplate(connectionFactory)
```

#### R2dbcEntityOperations
R2dbcEntityTemplateê°€ ìƒì†í•˜ê³  ìˆëŠ” ê¸°ëŠ¥ë“¤ì— ëŒ€í•œ í´ë˜ìŠ¤ì´ë‹¤.
ì—¬ê¸°ì—ëŠ” 
Select : ReactiveSelectOperation
Insert : ReactiveInsertOperation
Update : ReactiveUpdateOperation
Delete : ReactiveDeleteOperation

#### ê¸°ë³¸ì ì¸ ì˜ˆì œ
#### Select ì˜ˆì œ
```kotlin
val r2dbcTemplate = R2dbcEntityTemplate(connectionFactory)

var query = Query.query(
	Criteria.where("name").is("ABC")
)

r2dbcTemplate.select(User::class.java)
             .from("user")
            .matching(query)
            .first()
            .doOnNext{
               it->log.info{it}
            }
            .subscribe()
```

#### Update ì˜ˆì œ
```kotlin
val r2dbcTemplate = R2dbcEntityTemplate(connectionFactory)

var query = Query.query(
	Criteria.where("name").is("ABC")
)

var update = Update.update("name","XYZ")

r2dbcTemplate.update(User::class.java)
			.inTable("user")
            .matching(query)
            .apply(update)
            .doOnNext{
				it->log.info{it}
            }
            .subscribe()
```

#### ë” ì‰½ê²Œ ì‚¬ìš©í•˜ë„ë¡ êµ¬í˜„ëœ ë°©ì‹
```kotlin
	r2dbcTemplate.select(query,User::class.java) //selcet
    r2dbcTemplate.insert(user) // insert
    r2dbcTemplate.update(user) //update
```

## R2DBC Repository
JPAì˜ JPA Repository ì¸í„°í˜ì´ìŠ¤ ì²˜ëŸ¼ R2DBCì—ì„œ CRUDì™€ ê°™ì€ ê¸°ë³¸ì ì¸ ê¸°ëŠ¥ë“¤ì´ ì‘ì„±ë˜ì–´ìˆëŠ” ì¸í„°í˜ì´ìŠ¤
ê¸°ë³¸ì ì¸ ê¸°ëŠ¥ì´ë‚˜ í•¨ìˆ˜ëª…ë“±ë“± JPA Repositoryì™€ ê±°ì˜ ë™ì¼í•¨.

### SimpleR2dbcRepository
R2DBC Repositoryì˜ ê¸°ëŠ¥ë“¤ì´ êµ¬í˜„ë˜ì–´ìˆëŠ” êµ¬í˜„ì²´ì´ë‹¤.

í•˜ì§€ë§Œ nê°œì˜ ê²°ê³¼ë§Œ ê°€ì ¸ì˜¤ëŠ” ë“±ì˜ ê¸°ëŠ¥ì€ ì œê³µë˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ì¿¼ë¦¬ ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•´ì•¼í•œë‹¤

### Query Method
ë³µì¡í•œ ì¿¼ë¦¬ë“¤ì„ ë¯¸ë¦¬ ì‘ì„±í•´ë‘¬ì„œ ì‹¤í–‰í•˜ëŠ” ë°©ë²• JPAì—ì„œ @Queryì–´ë…¸í…Œì´ì…˜ê³¼ ë™ì¼

#### ì—…ë°ì´íŠ¸ ì˜ˆì œ
```kotlin
@Modifying
@Query("update user set name = :name where id = :id")
fun updateNameById(String name, Long id) : Mono<Integer>
```



# JPA 
## JPA ì‚¬ìš©í•˜ëŠ” ì´ìœ 
1. ìƒì‚°ì„± => JDBC APIì™€ SQL ë¬¸ì„ ëª¨ë‘ ì‘ì„±í•´ì•¼í•˜ëŠ” ë¬¸ì œ í•´ê²°
2. ìœ ì§€ ë³´ìˆ˜ => SQLì— ì˜ì¡´í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ìˆ˜ì •í•  ì½”ë“œê°€ ì¤„ì–´ë“¦
3. ì„±ëŠ¥  => JPAë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ìˆ˜ë§ì€ ìµœì í™”ë¡œ ë‚´ê°€ ì§œëŠ”ê±°ë³´ë‹¤ ì„±ëŠ¥ ì¢‹ìŒ!

## Entity ìƒì„± ê¸°ì´ˆ

```kotlin
@Entity
@Table (name = "MEMBER")
data class Member (
    @Id
    @Column(name = "ID")
    private val id : String?,

)
```

### Column ì–´ë…¸í…Œì´ì…˜ì— DDL ì¡°ê±´ ì¶”ê°€

```kotlin
    @Id
    @Column(name = "ID", nullable = false, length = 16)
    val id : String,
```

### ENTITYì— JSONê°ì²´ ì‚¬ìš©í•˜ê¸°

```kotlin
@Entity
@Table(name = "USER")
data class User(
    @Type(value = JsonType::class)
    @Column(name = "vote_list", columnDefinition = "longtext")
    val voteList: HashMap<String,Any>,
```

ì´ë ‡ê²Œ Typeì„ JsonTypeìœ¼ë¡œ columnDefinitionì„ longtextë¡œ ì„¤ì •í•˜ê³  ë³€ìˆ˜ íƒ€ì…ì„ HashMapìœ¼ë¡œ ì§€ì •í•´ì£¼ë©´ ëœë‹¤.


## ê¸°ë³¸í‚¤ ìƒì„±ì „ëµ

### ê¸°ë³¸í‚¤ ì§ì ‘í• ë‹¹ ì „ëµ

```kotlin
val member = Member(  )
member.setId("id")  // idë¥¼ ì§ì ‘ ë„£ì–´ì£¼ëŠ” ë°©ì‹
em.persist(member)
```
### IDENTITY ì „ëµ

```kotlin
data class Member (
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    val id : String,
```

ì´ ì „ëµì„ ì‚¬ìš©í•˜ë©´ ë°ì´í„°ë² ì´ìŠ¤ê°€ ìë™ìœ¼ë¡œ ê¸°ë³¸í‚¤ë¥¼ ìƒì„±í•˜ê²Œ í•˜ëŠ” ì „ëµìœ¼ë¡œ idë¥¼ ì¿¼ë¦¬ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì „ì†¡í•œ í›„ì— ì•Œ ìˆ˜ìˆë‹¤.

ì˜ì† ìƒíƒœê°€ ë˜ê¸°ìœ„í•´ì„œëŠ” idê°€ í•„ìš”í•˜ê¸° ë•Œë¬¸ì— em.persist()ë¥¼ í˜¸ì¶œí•˜ëŠ” ì¦‰ì‹œ ë°ì´í„°ë² ì´ìŠ¤ì— ì „ì†¡ëœë‹¤.

### Sequence ì „ëµ

```kotlin
data class Member (
    @Id
    @GeneratedValue(strategy = GenerationType.SEQUENCE, generator = "SEQ_GENERATOR")
    val id : String,
```

ìœ ì¼í•œ ê°’ì„ ìˆœì„œëŒ€ë¡œ ìƒì„±í•˜ëŠ” ì‹œí€€ìŠ¤ë¥¼ ì‚¬ìš©í•œ ë°©ì‹ìœ¼ë¡œ ì˜¤ë¼í´, H2ë“± ì‹œí€€ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” DBì—ì„œë§Œ ì‚¬ìš©ê°€ëŠ¥.

IDENTITYì™€ ë‹¤ë¥´ê²Œ em.persist()ë¥¼ í˜¸ì¶œí•  ë•Œ ì‹œí€€ìŠ¤ë¥¼  ì‚¬ìš©í•´ì„œ idë¥¼ ì¡°íšŒí•´ì„œ ì—”í‹°í‹°ì— ë„£ëŠ”ë‹¤. ê·¸í›„ commitì„ í•˜ë©´ ê·¸ë•Œ ë””ë¹„ì— ì €ì¥ëœë‹¤.

### í…Œì´ë¸” ì „ëµ

```kotlin
data class Member (
    @Id
    @GeneratedValue(strategy = GenerationType.Table, generator = "SEQ_GENERATOR")
    val id : String,
```

SEQ_GENERATORë¼ëŠ” ì´ë¦„ì˜ í…Œì´ë¸”ì— ë‹¤ìŒ ì‹œí€€ìŠ¤ ê°’ì„ ê°€ì§€ë„ë¡ ë§Œë“¤ì–´ ë†“ê³  ê·¸ í…Œì´ë¸”ì„ generatorë¡œ ë§¤í•‘í•œë‹¤.

ê·¸ëŸ¼ ê·¸ í…Œì´ë¸”ì—ì„œ ìë™ì ìœ¼ë¡œ ì›í•˜ëŠ” ì—”í‹°í‹°ì— idë¥¼ ë‹¤ìŒ ì‹œí€€ìŠ¤ë¡œ ì—°ê²°í•œë‹¤.

### Auto ì „ëµ

```kotlin
data class Member (
    @Id
    @GeneratedValue(strategy = GenerationType.Auto)
    val id : String,
```
JPAê°€ ë°ì´í„°ë² ì´ìŠ¤ì— ë”°ë¼ ìœ„ì˜ ì „ëµë“¤ì¤‘ í•˜ë‚˜ë¥¼ ìë™ìœ¼ë¡œ ì„ íƒí•œë‹¤.

## ì—°ê´€ê´€ê³„ ë§¤í•‘ ê¸°ì´ˆ

### @ManyToOne
```kotlin
@Entity
@Table (name = "MEMBER")
data class Member (
    @ManyToOne
    @JoinColumn(name = "TEAM_ID") // ë§¤í•‘í•  ì»¬ëŸ¼ëª…
    var team : Team? = null  // ë§¤í•‘í•  ê°ì²´ ì„ ì–¸
```

```kotlin
@Entity
@Table(name = "TEAM")
data class Team(
    @Id
    @GeneratedValue
    @Column(name = "TEAM_ID") // ë§¤í•‘ë˜ëŠ” ì»¬ëŸ¼ëª…
    val id :Long? =null,
)
```

#### í…ŒìŠ¤íŠ¸ì½”ë“œ

```kotlin
@Test
fun createTeamAndMemberIntoTeam(){
	val team = service.createNewTeam("team1")  // Teamê°ì²´ ìƒì„±í›„ ì˜ì†í•˜ëŠ” í•¨ìˆ˜
	val member = Member(name = "sihwan", passWord = "testPW")
	service.registerMember(member,team)
}
```

ì—¬ê¸°ì„œ ì¤‘ìš”í•œ ì ì€ íŒ€ì„ memberì— ë„£ê³  ì˜ì†ì‹œí‚¤ê¸° ì „ì— íŒ€ì„ ë¨¼ì € ì˜ì†ì‹œì¼œì•¼ í•œë‹¤.

### @OneToMany + ì–‘ë°©í–¥ ë§¤í•‘

```kotlin
@OneToMany(mappedBy = "team")
val members : MutableList<Member> = mutableListOf<Member>()
}
```
mappedByëŠ” ì—°ê´€ê´€ê³„ë¥¼ ê°–ëŠ” ë‹¤ë¥¸ í…Œì´ë¸”ì— í•„ë“œë¥¼ ì“´ë‹¤.

mappedByë¥¼ ë„£ì€ ìª½ì€ ì—°ê´€ê´€ê³„ì˜ ì£¼ì¸ì´ ì•„ë‹ˆê¸° ë•Œë¬¸ì— ìˆ˜ì •ì„ í•  ìˆ˜ ì—†ë‹¤.

```kotlin
@Entity
@Table (name = "MEMBER")
class Member (
    @ManyToOne
    @JoinColumn(name = "TEAM_ID")
    var team : Team? = null
) {
    fun teamSet(team: Team) {
        if (this.team != null){
            this.team!!.members.remove(this)
        }
        this.team = team
        team.members.add(this)
    }
}
```

teamì„ ë„£ëŠ”ë‹¤ê³  í•´ì„œ ì—°ê´€ í…Œì´ë¸”ì— ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ë˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ì§ì ‘ ë„£ì–´ì£¼ì–´ì•¼ í•œë‹¤.

### ì—°ê´€ê´€ê³„ì— ìˆëŠ” ë°ì´í„° ì‚­ì œ
ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ì‹¶ì„ë° ê´€ê³„ë¥¼ ê°€ì§€ê³  ìˆëŠ” í…Œì´ë¸”ì´ ìˆìœ¼ë©´ ê·¸ ë°ì´í„°ì™€ ì—°ê´€ëœ ê³³ì—ì„œ ëª¨ë‘ ì˜ì†ì„ í•´ì§€í•´ì•¼ í•œë‹¤.

```kotlin
fun deleteTeam(teamName : String){
	val members = jpqlQuery.findMembersByTeamName(teamName)
	members?.forEach {
	    it.team = null
	}
	val team =jpqlQuery.findTeamByTeamName(teamName)
	em.remove(team)
}
```
ì´ë ‡ê²Œ teamNameì„ ê°€ì§„ teamì„ ì‚­ì œí•˜ê³  ì‹¶ì„ ë•ŒëŠ”  teamNameì„ ê°€ì§„ memberë“¤ì„ ì°¾ì•„ì„œ member.teamì„ nullë¡œ ë°”ê¿”ì£¼ê³  remove í•´ì•¼í•œë‹¤.

## JPQL
JPQLì€ ì—”í‹°í‹° ê°ì²´ë¥¼ ì¡°íšŒí•˜ëŠ” ê°ì²´ì§€í–¥ ì¿¼ë¦¬ë‹¤.

### whereì ˆë¡œ ê°’ì°¾ê¸°
```kotlin
fun findTeamByTeamName(teamName : String): Team? {
	val jpql = "select t from Team t where t.name =: name"
	return em.createQuery(jpql, Team::class.java)
	    .setParameter("name", teamName)
	    .singleResult  // ê°’ì´ í•œê°œì¼ ê²½ìš°
	// .resultList  // ê°’ì´ ì—¬ëŸ¬ê°œì¼ ê²½ìš°
}
```
íŒ€ì´ë¦„ìœ¼ë¡œ íŒ€ ê²€ìƒ‰í•˜ëŠ” ì¿¼ë¦¬

### ì—°ê´€ëœ í…Œì´ë¸” JOINí›„ whereì ˆë¡œ ì¡°ê±´ì— ë§ëŠ” ê°’ ì°¾ê¸°
```kotlin
fun findMembersByTeamName(teamName: String): MutableList<Member>? {
	val jpql = "select m from Member m join m.team t where t.name =: teamName"
	return em.createQuery(jpql, Member::class.java)
	    .setParameter("teamName", teamName)
	    .resultList
}
```
íŠ¹ì´í•˜ê²Œ select *ë¡œ ì‘ì„±í•˜ë©´ ì•ˆëœë‹¤. Memberíƒ€ì…ì˜ mê³¼ m.teamíƒ€ì…ì˜ të¥¼ ì¡°ì¸í•˜ê³  whereì ˆë¡œ ì¡°ê±´ì„ ì¶”ê°€í•˜ëŠ” ì½”ë“œì´ë‹¤.

### jpqlë¡œ ì¡°íšŒí•œ ê°’ì„ DTOì™€ ì—°ê²°í•˜ê¸°
```kotlin
val jpql = "select new íŒ¨í‚¤ì§€ëª….DTOëª…(i.id,i.name) from Item i "
val voteList = em.createQuery(jpql,DTOëª…::class.java).resultList
}
```
ì—¬ê¸°ì„œ íŠ¹ì´í•œì ì€ JAVAì™€ ê°™ì´ newë¥¼ ì‚¬ìš©í•˜ì—¬ì•¼í•˜ê³  DTOë§Œ ì“°ë©´ ì•ˆë˜ë©° íŒ¨í‚¤ì§€ê¹Œì§€ ì¨ì£¼ì–´ì•¼í•œë‹¤.

### NamedQueryë¡œ ì •ì ì¿¼ë¦¬ ì‚¬ìš©í•˜ê¸°

Entityì— NamedQueryë¥¼ ì‘ì„±í•˜ê³ 

```kotlin
@Entity
@NoArgsConstructor
@NamedQuery(
    name = "User.findByEmail",
    query = "select u from User u where u.email =: email"
)
@Table(name = "USER")
data class User(
'''
)
```

ë‹¤ìŒê³¼ ê°™ì´ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

```kotlin
val user = em.createNamedQuery("User.findByEmail",User::class.java)
		.setParameter("email,email).getSingleResult
```

### ì„œë¸Œì¿¼ë¦¬

#### EXSITS

ì„œë¸Œì¿¼ë¦¬ ê²°ê³¼ê°€ ì¡´ì¬í•˜ë©´ ì°¸.

```kotlin
val jqpl = "select m from Member m"
		+ "where exists(select t from m.team t where t.name = 'A')"
```

#### ALL, ANY

ALLì€ ì„œë¸Œì¿¼ë¦¬ í…Œì´ë¸” ëª¨ë“  ê°’ì— ëŒ€í•´ ì¡°ê±´ì´ ë§Œì¡±í•´ì•¼ ì°¸.
ANYëŠ” í•˜ë‚˜ë§Œ ë§Œì¡±í•´ë„ ì°¸.

```kotlin
val jqpl = "select m from Member m"
		+ "where m.count > ALL (select n.count from NewMember n)" // m.countê°€ ëª¨ë“  n.countë³´ë‹¤ ì»¤ì•¼ì§€ë§Œ ì°¸.


val jqpl2 = "select m from Member m"
		+ "where m.count > ANY (select n.count from NewMember n)" // m.countê°€ n.count í•˜ë‚˜ë³´ë‹¤ë§Œ í¬ë©´ ì°¸.
```


## Criteria

JPQLë³´ë‹¤ ë™ì ì¿¼ë¦¬ë¥¼ ì•ˆì „í•˜ê²Œ ìƒì„±í•˜ëŠ” ë¹Œë” API
ë‹¨, ê°€ë…ì„±ì´ ì¢€ ë–¨ì–´ì§..

### ì¿¼ë¦¬ ìƒì„±

```kotlin
val cb = em.criteriaBuilder  //CriteriaBuilder
val cq = cb.createQuery(User::class.java) //CriteriaQuery
```

###= Select

##### jpqlì½”ë“œ

```kotln
val userJpql = "select distinct u from User u where u.email =: email"
val user = em.createQuery(userJpql, User::class.java).setParameter("email", email).singleResult
```

##### Criteria ì½”ë“œ

```kotln
val cb = em.criteriaBuilder
val cq = cb.createQuery(User::class.java).apply {
    val u = from(User::class.java)
    select(u)
    where(cb.equal(u.get<String>("email"),email))
}
val user = em.createQuery(cq).singleResult

```

## QueryDSL

### í™˜ê²½ ì„¤ì •
```kotlin
plugins {
	'''
	kotlin("kapt") version "1.9.22"
	idea
}


dependencies {
	//querydsl
	implementation("com.querydsl:querydsl-jpa:5.0.0:jakarta")
	kapt("com.querydsl:querydsl-apt:5.0.0:jakarta")
}

idea {
	module {
		val kaptMain = file("${layout.buildDirectory}/generated/querydsl")
		sourceDirs.add(kaptMain)
		generatedSourceDirs.add(kaptMain)
	}
}

kapt {
	javacOptions {
		option("querydsl.entityAccessors", true)
	}
	arguments {
		arg("plugin", "com.querydsl.apt.jpa.JPAAnnotationProcessor")
	}
}


```

### Projectionì„ í™œìš©í•œ DTO SELECT ì˜ˆì œ

```kotlin
fun newLoadPopularVote(): MutableList<PopularVoteResponseDTO> {
	val voteList = queryFactory.select(
	    Projections.constructor(
		PopularVoteResponseDTO::class.java,
		vote.title,
		vote.voteUrl,
		vote.id,
		vote.mainImageUrl,
		vote.allVoteSum	
	    )			 	      //select
	).from(vote)
	    .where(vote.publicShare.isTrue)  //where
	    .orderBy(			    //order
		vote.allVoteSum.desc()
	    )
	    .limit(5)			   //limit
	    .fetch()
	return voteList
}
```



# Redis

## RedisConfig ì‘ì„±
```kotlin
@Configuration(value = "redisConfig")
@EnableRedisRepositories
@RequiredArgsConstructor
class RedisConfig {

    @Value("\${spring.data.redis.host}")
    var host : String

    @Value("\${spring.data.redis.port}")
    var port : Int


    @Bean
    fun redisConnectionFactory(): RedisConnectionFactory? {
        val lettuceConnectionFactory = LettuceConnectionFactory(host, port)
        lettuceConnectionFactory.start()
        return lettuceConnectionFactory
    }

    @Bean
    fun redisTemplate(): RedisTemplate<String, String> {
        val redisTemplate = RedisTemplate<String, String>()
        redisTemplate.connectionFactory = redisConnectionFactory()
        redisTemplate.keySerializer = StringRedisSerializer()
        redisTemplate.valueSerializer = StringRedisSerializer()
        redisTemplate.afterPropertiesSet()
        return redisTemplate
    }
}
```
## RedisRepository êµ¬í˜„

```kotlin
@Repository
class RedisRepository {

    val redisTemplate by lazy { RedisConfig().redisTemplate() }

    fun save(jwt : String, email : String){
        redisTemplate.opsForValue().set(jwt,email)
    }

    fun loadByJwt(jwt : String): String? {
        return redisTemplate.opsForValue().get(jwt)
    }

}
```
# ReactiveRedis

## ReactiveRedisConfig
```kotlin
    @Bean
fun reactiveRedisConnectionFactory(): ReactiveRedisConnectionFactory {
	val lettuceConnectionFactory = LettuceConnectionFactory(host, port)
	lettuceConnectionFactory.start()
	return lettuceConnectionFactory
}
```

## ReactiveRedisRepository
```kotlin
@Repository
class RedisR2dbcRepository(
    private val redisTemplate : ReactiveRedisTemplate<String,String>,
    private val mapper: ObjectMapper
) {

    fun save(key : String, value : String, duration: Duration): Mono<Boolean> {
        return redisTemplate.opsForValue().set(key,value, duration)
    }

    fun load(key:String): Mono<String> {
        return redisTemplate.opsForValue().get(key)
    }

    fun <T> load(key : String, type : Class<T>): Mono<T> {
        return redisTemplate.opsForValue()
                            .get(key)
                            .map { value-> mapper.readValue(value,type) }
    }

    fun removeRtmp(streamKey: String): Mono<String> {
        return redisTemplate.opsForValue().getAndDelete(streamKey)
    }

}
```


---

# Spring Security

## OAuth 2.0

### Google

#### OAuth ìœ ì € ì„œë¹„ìŠ¤ ì»¤ìŠ¤í…€ êµ¬í˜„
```kotlin
@Service
class OAuth2UserService : DefaultOAuth2UserService() {

    override fun loadUser(userRequest: OAuth2UserRequest?): OAuth2User {
	// ë™ì‘
        return super.loadUser(userRequest)
    }
}
```
OAuthë¡œ ì‚¬ìš©ì ë°›ì•„ì˜¤ëŠ” ì„œë¹„ìŠ¤ êµ¬í˜„

#### SecurityConfig íŒŒì¼ êµ¬í˜„

```kotlin
import org.springframework.security.config.annotation.web.invoke
@Configuration
@EnableWebSecurity
class SecurityConfig {
    @Bean
    fun filterChain(http: HttpSecurity): SecurityFilterChain {
        http { // kotlin DSL
            httpBasic { disable() }
            csrf { disable() }
            cors { }
            authorizeRequests {
                authorize("/user/**", hasAuthority("ROLE_USER"))
            }
            oauth2Login {
                loginPage = "/loginPage"
                defaultSuccessUrl("/",true)
                userInfoEndpoint {  }
            }
        }
        return http.build()
    }
```
websecurityconfigureradapterê°€ Deprecatedë˜ë©´ì„œ Kotlinì€ Kotlin DSLì„ ì‚¬ìš©í•´ì•¼ í•˜ê²Œ ë¨.

ë”°ë¼ì„œ

import org.springframework.security.config.annotation.web.invoke ë¥¼ ê¼­ ë„£ì–´ì¤˜ì•¼í•¨

## SuccessHandler êµ¬í˜„

```kotlin
    @Bean
    fun filterChain(http: HttpSecurity): SecurityFilterChain {
        http {
		'''
            oauth2Login {
                '''
                authenticationSuccessHandler = OAuthSuccessHandler()
            }
```
filterChainì— http.oauth2Login ì— authenticationSuccessHandlerë¥¼ ì¶”ê°€í•˜ê³  í•¸ë“¤ëŸ¬ë¥¼ ë“±ë¡í•œë‹¤.

```kotlin
@Component(value = "authenticationSuccessHandler")
class OAuthSuccessHandler : AuthenticationSuccessHandler {
    // OAuthë¡œê·¸ì¸í›„ ë¶ˆëŸ¬ì™€ì„œ í•  ë™ì‘êµ¬í˜„
    override fun onAuthenticationSuccess(request: HttpServletRequest, response: HttpServletResponse, authentication: Authentication) {
        val oAuth2User = authentication.principal as OAuth2User
        val name = oAuth2User.attributes["name"] as String
        val email = oAuth2User.attributes["email"] as String
}
    }
}
```
## Filterì¶”ê°€ë¡œ JWT í† í° ê²€ì¦í•˜ê¸°

#### addFilterBeforeë¡œ ì¶”ê°€í•œë‹¤

```kotlin
class SecurityConfig(val oAuthSuccessHandler: OAuthSuccessHandler, val oAuthFailureHandler: OAuthFailureHandler) {
    @Bean
    fun filterChain(http: HttpSecurity): SecurityFilterChain {
        http {
	'''
            addFilterBefore<UsernamePasswordAuthenticationFilter> (JwtAuthenticationFilter(JwtTokenProvider()))
        }
        return http.build()
    }
}
```

#### JwtAuthenticationFilter êµ¬í˜„

```kotlin
class JwtAuthenticationFilter(
        private val jwtTokenProvider: JwtTokenProvider
) : GenericFilterBean() {
    override fun doFilter(request: ServletRequest?, response: ServletResponse?, chain: FilterChain?) {
        val token = resolveToken(request as HttpServletRequest)

        if (token != null && jwtTokenProvider.validateToken(token)) {
            val authentication = jwtTokenProvider.getAuthentication(token)
            SecurityContextHolder.getContext().authentication = authentication
            println("doFilterChain:$authentication")
        }
        chain?.doFilter(request, response)
    }

    private fun resolveToken(request : HttpServletRequest) : String? {
        val bearerToken = request.getHeader("Authorization")
        return if (StringUtils.hasText(bearerToken) && bearerToken.startsWith("Bearer")) {
            bearerToken.substring(7)
        } else {
            null
        }
    }

}
```

# Spring Batch

## ì˜ì¡´ì„± ì¶”ê°€

```kotlin
	//Spring Batch
	implementation("org.springframework.boot:spring-batch-test")
	implementation("org.springframework.boot:spring-boot-starter-batch")
```


## ê¸°ì´ˆ Configuration

```kotlin
@Configuration
class JobConfig(
    private val jobRepository: JobRepository,
    private val transactionManager: PlatformTransactionManager,
    private val tasklet: VoteTasklet
) {
    @Bean
    fun job(): Job {
        return JobBuilder("job", jobRepository)
            .start(step())
            .build()
    }
    @Bean
    fun step(): Step {
        return StepBuilder("step", jobRepository)
            .tasklet(tasklet, transactionManager)
            .build()
    }
}
```

## ê¸°ì´ˆ Tasklet ì •ì˜
```kotlin
@StepScope
@Component
class VoteTasklet(
    val userRepository: UserRepository,
    val userRankingRepository: UserRankingRepository
): Tasklet {
    val log = KotlinLogging.logger{}
    override fun execute(contribution: StepContribution, chunkContext: ChunkContext): RepeatStatus? {
        log.info { "tasklet start" }

        //read
        val rankingList = userRepository.loadRanking()


        //process
        val userIdList = rankingList.map{it.id}


        //write
        userRankingRepository.resetAndSave(userIdList)

        return RepeatStatus.FINISHED
    }
}
```

## @Scheduledë¥¼ ì‚¬ìš©í•´ ì£¼ê¸°ì ìœ¼ë¡œ ì‹¤í–‰í•˜ê¸°

```kotlin
@Component
class SchedulerConfig(
    val jobLauncher: JobLauncher,
    val jobConfig: JobConfig
) {
    val log = KotlinLogging.logger {  }
    @Scheduled(fixedRate  = 1000) //ì„ì‹œë¡œ 10ì´ˆë§ˆë‹¤ ìƒì„±
    fun popularVoteRenew(){
        log.info{"RankingRenew Start"}
        try {
            jobLauncher.run(jobConfig.job(),JobParameters())
        } catch (e: JobExecutionAlreadyRunningException) {
            log.error(e.message)
        } catch (e: JobInstanceAlreadyCompleteException) {
            log.error(e.message)
        } catch (e: JobParametersInvalidException) {
            log.error(e.message)
        } catch (e: JobRestartException) {
            log.error(e.message)
        }
        log.info{"RankingRenew End"}
    }
}
```

# Kafka

## ConfigíŒŒì¼ ì‘ì„±

### KafkaTemplate ë¹ˆ ë“±ë¡

```kotlin
@Configuration
@EnableKafka
class KafkaConfig(
    @Value("\${spring.kafka.bootstrap-servers}")
    var bootStrapServers : String
) {


    @Bean
    fun kafkaTemplate() : KafkaTemplate<String, Any> {
        return KafkaTemplate<String,Any>(producerFactory());
    }
```

### ProducerFactory ë¹ˆ ë“±ë¡

```kotlin
@Bean
fun producerFactory() : ProducerFactory<String,Any>{
	val producerConfig = HashMap<String,Any>()
	producerConfig[ProducerConfig.BOOTSTRAP_SERVERS_CONFIG] = bootStrapServers
	producerConfig[ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG] = StringSerializer::class.java
	producerConfig[ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG] = StringSerializer::class.java
	return DefaultKafkaProducerFactory(producerConfig)
}
```

### ConsumerFactory ë¹ˆ ë“±ë¡

```kotlin
@Bean
fun consumerFactory() : ConsumerFactory<String,Any>{
	val consumerConfig = HashMap<String,Any>()
	consumerConfig[ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG] = bootStrapServers
	consumerConfig[ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG] = StringDeserializer::class.java
	consumerConfig[ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG] = StringDeserializer::class.java
	return DefaultKafkaConsumerFactory(consumerConfig)
}
```

### ConcurrentKafkaListenerContainerFactory ë¹ˆ ë“±ë¡

#### Consumerê°€ Listnerë¥¼ í†µí•´ ë©”ì‹œì§€ê°€ ë“¤ì–´ì˜¤ëŠ”ì§€ ë°›ì•„ì˜¬ ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ê°ì²´

```kotlin
@Bean
fun kafkaListenerContainerFactory() : ConcurrentKafkaListenerContainerFactory<String, Any>{
	val conCurrentListener = ConcurrentKafkaListenerContainerFactory<String,Any>()
	conCurrentListener.consumerFactory = consumerFactory()
	return conCurrentListener
}
```
## í”„ë¡œë“€ì„œ ì„œë¹„ìŠ¤ êµ¬í˜„

```kotlin
@Service
class KafkaProducerService(
    val kafkaTemplate : KafkaTemplate<String,Any>
) {

    val testTopic = "testTopic"

    fun pub(msg : String){
        kafkaTemplate.send(testTopic,msg)
    }

}
```

## ì»¨ìŠˆë¨¸ ë¦¬ìŠ¤ë„ˆ êµ¬í˜„

```kotlin
@Service
class KafkaConsumerService {
    private val log = KotlinLogging.logger {  }
    @KafkaListener(topics= ["testTopic"], groupId = "kafkaTest")
    fun consumer(msg: String) {
        log.info { "KafkaConsumer: $msg" }
    }
}
```

# Kafka Streams

## í™˜ê²½êµ¬ì„±

```kotlin
@EnableKafkaStreams
@EnableKafka
@Configuration
class KafkaConfig(
    @Value("\${spring.kafka.bootstrap-servers}")
    var bootStrapServers : String
) {
    @Bean(name = [KafkaStreamsDefaultConfiguration.DEFAULT_STREAMS_CONFIG_BEAN_NAME])
    fun kafkaStreamConfig() : KafkaStreamsConfiguration{
        val kStreamConfig = hashMapOf<String,Any>()
        kStreamConfig[StreamsConfig.APPLICATION_ID_CONFIG] = "stream-test"
        kStreamConfig[StreamsConfig.BOOTSTRAP_SERVERS_CONFIG] = bootStrapServers
        kStreamConfig[StreamsConfig.DEFAULT_KEY_SERDE_CLASS_CONFIG] = Serdes.String().javaClass.name
        kStreamConfig[StreamsConfig.DEFAULT_VALUE_SERDE_CLASS_CONFIG] = Serdes.String().javaClass.name
        kStreamConfig[StreamsConfig.NUM_STREAM_THREADS_CONFIG] =1
        return KafkaStreamsConfiguration(kStreamConfig)
    }
}
```

## ì„œë¹„ìŠ¤ ê¸°ì´ˆêµ¬ì„±

```kotlin
@Service
class KafkaStreamService {

    val stringSerde: Serde<String> = Serdes.String()

    @Autowired
    fun buildPipeline(sb : StreamsBuilder) {
        val kStream = sb.stream("testTopic", Consumed.with(stringSerde, stringSerde))
        kStream.filter { key, value ->
            value.contains("test")
        }.to("testStream")
    }
}
```

```text
testTopicìœ¼ë¡œ ë“¤ì–´ì˜¤ëŠ” ë©”ì‹œì§€ë¥¼ ì»¨ìŠ˜í•´ì„œ ê°’ì— 
testê°€ ë“¤ì–´ê°€ëŠ” ê°’ì„ testStream Topicìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ë‚¸ë‹¤.
```

# ì—”í‹°í‹° ë©”ë‹ˆì €
## ì—”í‹°í‹° ë§¤ë‹ˆì € ì„¤ì •

```kotlin
	val emf = Persistence.createEntityManagerFactory("jpaTest")
	val em = emf.createEntityManager()
```

## íŠ¸ëœì­ì…˜ ê´€ë¦¬

```kotlin
	val tx = em.transaction
	try {
		tx.begin()
		logic(em)
		tx.commit()
	} catch (e: Exception) {
		tx.rollback()
	} finally {
		em.close()
	}
```

## repositoryì—ì„œ emê³¼ tx í™œìš©

```kotlin
class MemoryMemberRepository : MemberRepository {

    override val em: EntityManager
        get() = EntityManagerObject.em
    override val tx: EntityTransaction
        get() = EntityManagerObject.tx

    override fun save(member: Member) {
        tx.begin()
        em.persist(member)
        tx.commit()
    }

    override fun findById(id: String): Member {
        return em.find(Member::class.java, id)
    }

}
```

## @Transactionalê³¼ @PersistenceContextë¥¼ í™œìš©í•œ ì¤‘ë³µì½”ë“œ ì œê±°

#### ì—”í‹°í‹° ë§¤ë‹ˆì € ì˜ì¡´ì„± ì£¼ì… @PersistenceContext

``` kotlin
@Repository
class BaseRepository {
    @PersistenceContext
    lateinit var em : EntityManager
}
```

#### Transaction ë°˜ë³µì½”ë“œ @Transactionalë¡œ ëŒ€ì²´

``` kotlin
/*
tx.begin()
---
tx.commit()
*/

ìœ„ì™€ ê°™ì€ ì—­í• ì„ @Transactionalì´ ëŒ€ì‹ í•¨.

@Transactional
class UserService(val userRepository: UserRepository):BaseService() {
```

## ì½”ë£¨í‹´ì„ ì‚¬ìš©í•˜ëŠ” suspend functionì€ ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œ í•œë²ˆì— @Transactionalì´ ì ìš©ë˜ì§€ ì•ŠìŒ.

### ì ìš©ë°©ë²• ì¶”ê°€ì˜ˆì •

#### í˜„ì¬ ë°©ì‹

##### ê° Repository í•¨ìˆ˜ë§ˆë‹¤ @Transactionalì„ ì¶”ê°€í•´ì¤€ë‹¤.

# Elastic Search

## Dependency
```kotlin
implementation("org.springframework.boot:spring-boot-starter-data-elasticsearch")
```

## Config
```kotlin
@Configuration
@Import(DataSourceAutoConfiguration::class)
class ElasticConfig : ElasticsearchConfiguration() {
    override fun clientConfiguration(): ClientConfiguration {
        return ClientConfiguration.builder()
            .connectedTo("localhost:9200")
            .build()
    }
}
```

## Repository
```kotlin
@Repository
interface TestElasticSearch : ElasticsearchRepository<TestUserElastic,Long> {
    //fun getTestUserElasticsByEmailContains(email: String) : List<TestUserElastic>
}
```

# AWS

## S3

### S3Config ì‘ì„±
```kotlin
@Configuration
class S3Config(
        @Value("\${aws.s3.accessKey}")
        private val accessKey: String,
        @Value("\${aws.s3.secretKey}")
        private val secretKey: String,
) {
    @Bean
    fun amazonS3Client(): AmazonS3 {
        return AmazonS3ClientBuilder.standard()
                .withCredentials(
                        AWSStaticCredentialsProvider(BasicAWSCredentials(accessKey, secretKey))
                )
                .withRegion(Regions.AP_NORTHEAST_2)
                .build()
    }
}
```

### coroutineì‚¬ìš©í•œ ì—¬ëŸ¬ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì»¨íŠ¸ë¡¤ëŸ¬
```kotlin
@RestController
@RequestMapping("/")
class S3TestController(val amazonS3Client : AmazonS3) {
    @PostMapping("/multipart-files")
    suspend fun uploadMultipleFilesWithCoroutine(
            @RequestPart("uploadFiles") multipartFiles: List<MultipartFile>,
            @RequestParam type: String,
    ) = withContext(Dispatchers.IO) {
        val uploadJobs = multipartFiles.map {
            val objectMetadata = ObjectMetadata().apply {
                this.contentType = it.contentType
                this.contentLength = it.size
            }
            async {
                val putObjectRequest = PutObjectRequest(
                        "vote-share",
                        UUID.randomUUID().toString() + type,
                        it.inputStream,
                        objectMetadata,
                )
                amazonS3Client.putObject(putObjectRequest)
            }
        }
        uploadJobs.awaitAll()
        return@withContext "test Complete"
    }
}
```

# JUNIT

## Controllerí…ŒìŠ¤íŠ¸

mockMvcë¥¼ ì‚¬ìš©í•´ì„œ ì»¨íŠ¸ë¡¤ëŸ¬ í…ŒìŠ¤íŠ¸ë¥¼ í•  ìˆ˜ ìˆë‹¤.

``` kotlin

lateinit var mockMvc: MockMvc

@Test
@WithMockUser()
fun getMyPage() {
	mockMvc.perform (
	    get("URL")
		.contentType(MediaType.APPLICATION_JSON)
		.header("Authorization","TestJWT")
	).andExpect(status().isOk)
	    .andExpect(jsonPath("$.email").value(testEmail))
	    .andExpect(jsonPath("$.accessToken").value(testJwt))
    .andExpect(jsonPath("$.nickName").value(testName))

}
```

## ë¹„ë™ê¸° ì²˜ë¦¬ëœ ì»¨íŠ¸ë¡¤ëŸ¬ í…ŒìŠ¤íŠ¸ë°©ë²• (feat. test Responseê°€ ë¹ˆê°’ì¼ ê²½ìš° ì´ì— í•´ë‹¹í•¨.)

#### ìœ„ì™€ ë‹¤ë¥´ê²Œ performì„ ë¨¼ì €í•˜ê³  asyncDispatchë¥¼ í†µí•´ì„œ ì§„í–‰í•´ì•¼í•œë‹¤.

``` kotlin
val mvcResult = mockMvc.perform(
    multipart("/api/v1/vote/create_vote")
	.file(testImage)
	.file(testImages)
	.file(voteDTO)
	.contentType(MediaType.MULTIPART_FORM_DATA)
	.header("Authorization", testJwt.grantType + " " + testJwt.accessToken)
    ).andExpect(status().isOk)
    .andExpect(request().asyncStarted())
    .andExpect { request().asyncResult("body") }
    .andReturn()

mockMvc.perform(asyncDispatch(mvcResult))
    .andExpect(status().isOk)
    .andExpect(jsonPath("$.ë°˜í™˜ê°’").ì¡°ê±´)


```

[ì°¸ê³ ] https://docs.spring.io/spring-framework/reference/testing/spring-mvc-test-framework/async-requests.html



# ERROR

## Unable to load class [org.h2.Driver] 
h2 ì‚¬ìš©ì‹œ ìƒê¸°ëŠ” ì˜¤ë¥˜ë¡œ build.gradle.ktsì— ì˜ì¡´ì„± ì¶”ê°€ë¡œ í•´ê²°
```kotlin
	runtimeOnly ("com.h2database:h2")
	testImplementation ("org.springframework.boot:spring-boot-starter-test")
```

## Unable to locate persister
JPAê°€ ìë™ìœ¼ë¡œ Entity í´ë˜ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í•˜ëŠ” ìƒí™©ì´ ìƒê²¼ë‹¤.

ì—¬ëŸ¬ê°€ì§€ ë°©ë²•ì„ ì‹œë„í–ˆì§€ë§Œ ì•ˆëê³ , í•´ê²°í•œ ë°©ë²•ì€ persistence.xmlì— ì§ì ‘ classë¥¼ ì¶”ê°€í•´ì¤€ ê²ƒì´ë‹¤.

```xml
    <persistence-unit name="jpaTest">
        <class> com.shan.kopring.data.model.Member</class> //ì§ì ‘ ì¶”ê°€í•œ ë¶€ë¶„
        <properties>
		'''

persistence.xml
```

## Could not find mysql:mysql-connector-java
mysql ì—°ë™í•˜ëŠ” ê³¼ì •ì—ì„œ ìƒê¸´ ì˜¤ë¥˜ì´ë‹¤. ì´ìœ ëŠ” MySQL 8.0.31ë¶€í„° í´ë˜ìŠ¤ê°€ ë³€ê²½ë˜ì—ˆë‹¤. ë”°ë¼ì„œ

```kotlin
dependencies {
	//implementation ("mysql:mysql-connector-java") ë³€ê²½ì „
	implementation ("com.mysql:mysql-connector-j")  // ë³€ê²½í›„
```

## org.hibernate.PersistentObjectException: detached entity passed to persist
```kotlin
data class Member (
    @Id
    @GeneratedValue(strategy = GenerationType.AUTO)
    val id : Long? = null,
```
ì´ë ‡ê²Œ ê¸°ë³¸ììƒì„± ì „ëµì„ ì„ íƒí•œ ìƒíƒœì—ì„œ ì§ì ‘ idë¥¼ ë„£ì–´ì¤„ ê²½ìš° ì˜¤ë¥˜ ë°œìƒí•¨.

##  Type javax.servlet.http.HttpServletRequest not present
Spring Boot 3.XX ë²„ì „ì—ì„œ Swaggerë¥¼ ì ìš©ì‹œí‚¬ ë•Œ ìƒê¸´ ì˜¤ë¥˜

```kotlin
implementation("io.springfox:springfox-boot-starter:3.0.0")  // springfox ì—…ë°ì´íŠ¸ ì•ˆë¨
```

springfoxê°€ ì•„ë‹Œ springdocì„ ì‚¬ìš©í•˜ë©´ ì˜¤ë¥˜ ì—†ì´ ì‚¬ìš©ê°€ëŠ¥í•˜ë‹¤.

```kotlin
//swagger
implementation("org.springdoc:springdoc-openapi-starter-webmvc-ui:2.3.0")
implementation("io.swagger.core.v3:swagger-annotations:2.2.16")
```

## com.mysql.cj.jdbc.exceptions.CommunicationsException: Communications link failure

dockerì—ì„œ mysqlì„ ì—°ë™í•  ë•Œìƒê¸´ ì˜¤ë¥˜

application.propertiesì—ì„œ mysqlì£¼ì†Œë¥¼ localhostê°€ ì•„ë‹Œ mysql ì»¨í…Œì´ë„ˆ ì´ë¦„ìœ¼ë¡œ ì„¤ì •ì‹œ DNSì‚¬ìš©ìœ¼ë¡œ í•´ê²°

#### ì´ë•Œ ì¤‘ìš”í•œê±´ application.propertiesì™€ persistence.xmlì—ì„œë„ ë””ë¹„ë¥¼ ë³€ê²½í•´ì£¼ì–´ì•¼í•œë‹¤.

```
spring.datasource.url=jdbc:mysql://my:3306/database-name
 <property name="javax.persistence.jdbc.url" value="jdbc:mysql://mysql:3306/database-name"/>
```


## ì—°ê´€ëœ í…Œì´ë¸” ì°¸ì¡°ì‹œ ë¬´í•œ ë£¨í”„ì™€ StackOverFlowê°€ ìƒê¸°ëŠ” ê²½ìš°

Jsonìœ¼ë¡œ ë°”ê¾¸ëŠ” ê³¼ì •ì—ì„œ ì„œë¡œ ë¬´í•œìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ê¸° ë•Œë¬¸ì— ìƒê¸°ëŠ” ë¬¸ì œ.
@JsonBackReferneceë¥¼ ì¶”ê°€í•´ì£¼ì–´ì„œ ê·¸ ì»¬ëŸ¼ì„ jsonìœ¼ë¡œ ë°”ê¾¸ì§€ ì•Šì„ ìˆ˜ìˆìŒ.

``` kotlin
    @OneToMany(mappedBy = "user",fetch = FetchType.LAZY)
    @ToString.Exclude
    @JsonBackReference
    val teamList: MutableList<Team> = mutableListOf(),
```

## org.springframework.dao.CannotAcquireLockException: PreparedStatementCallback;

#### Spring Batch + @Scheduled ì‚¬ìš©ì‹œ DeadLockê³¼ í•¨ê»˜ ì´ëŸ¬í•œ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ë‹¤.

```kotlin
@EnableBatchProcessing
class JobConfig(
```

#### @EnableBatchProcessing ì´ê±¸ Job ì„¤ì • í´ë˜ìŠ¤ ë§¨ìœ„ì— ì‘ì„±í•´ì£¼ì–´ì•¼í•œë‹¤.

## Error : Timeout waiting for connection from pool

```text
amazonS3 *S3Object* ë¥¼ *close* í•´ì£¼ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— ë‹¤ìŒê³¼ ê°™ì€ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ë‹¤. 

S3ObjectëŠ” Closeableì„ implementsí•˜ê³  ìˆê¸° ë•Œë¬¸ì— *try-with-resources* ë¥¼ ì‚¬ìš©í•  ìˆ˜ìˆë‹¤.
```
*try-with-resources* ë€ AutoCloseable ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ê³  ìˆëŠ” ìì›ì— ëŒ€í•´ tryì•ˆì— ê·¸ ìì›ì„ ë„£ìœ¼ë©´ ì‘ì—…ì´ ëë‚˜ë©´ ìë™ìœ¼ë¡œ closeí•´ì£¼ëŠ” ê²ƒì„ ë§í•œë‹¤.



#### ì½”í‹€ë¦°ì—ì„œ ì‚¬ìš©ë²•!
ì½”í‹€ë¦°ì—ì„œëŠ” use ê³ ì°¨í•¨ìˆ˜ë¥¼ í†µí•´ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
```kotlin
fun readFirstLine(path: String): String {
    BufferedReader(FileReader(path)).use { br ->
        return br.readLine()
    }
}
```
## com.amazonaws.ResetException: The request to the service failed with a retryable reason, but resetting the request input stream has failed. See exception.getExtraInfo or debug-level logging for the original failure that caused this retry.;  If the request involves an input stream, the maximum stream buffer size can be configured via request.getRequestClientOptions().setReadLimit(int)

### ì´ ì˜¤ë¥˜ëŠ” AWSS3ì— íŒŒì¼ì„ PUTí•  ë•Œ inputStreamìœ¼ë¡œ ì—…ë¡œë“œí•  ë•Œ ìƒê¸°ëŠ” ë²„ê·¸ë¼ëŠ” ê²ƒì„ ì•Œì•„ëƒˆë‹¤. ì•„ë˜ëŠ” ì°¸ê³ í•œ ì‚¬ì´íŠ¸ì´ë‹¤.
https://stackoverflow.com/questions/30121218/aws-s3-uploading-large-file-fails-with-resetexception-failed-to-reset-the-requ

```kotlin
        val thumbNailFile = File(thumbNailPath)
        val request = PutObjectRequest(
            "video-stream-spring",
            thumbNailPath,
            thumbNailFile.inputStream(),
            ObjectMetadata()
        )
```
### ì´ë ‡ê²Œ ì‘ì„±í–ˆë˜ ì½”ë“œë¥¼

```kotlin
        val thumbNailFile = File(thumbNailPath)
        val request = PutObjectRequest(
            "video-stream-spring",
            thumbNailPath,
            thumbNailFile,
        )
```
### inputStreamì´ ì•„ë‹Œ ê·¸ëƒ¥ íŒŒì¼ ìì²´ë¡œ ì—…ë¡œë“œí•˜ë©´ ì˜¤ë¥˜ê°€ í•´ê²°ë˜ì—ˆë‹¤.
