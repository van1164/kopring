= kopring
:toc:

ifndef::imagesdir[:imagesdir: images]
image::kopring.png[scaledwidth=10%]



= 컨트롤러 활용
``` kotlin
@Controller
class MainController {

    @GetMapping("")
    @ResponseBody
    fun mainGetMap(model : Model): String {
        return "test"
    }
}
```

= JUnit을 사용한 테스트
``` kotlin
    @Test
    fun mainGetMap() {
        println(">> Assert getMapping()")
        val entity = restTemplate.getForEntity<String>("/")
        assertThat(entity.statusCode).isEqualTo(HttpStatus.OK)
        assertThat(entity.body).contains("test")
    }
```

= JPA  활용
== JPA 사용하는 이유
1. 생산성 => JDBC API와 SQL 문을 모두 작성해야하는 문제 해결
2. 유지 보수 => SQL에 의존하지 않기 때문에 수정할 코드가 줄어듦
3. 성능  => JPA라이브러리는 수많은 최적화로 내가 짜는거보다 성능 좋음!

== Entity 생성 기초

[source,kotlin]
----
@Entity
@Table (name = "MEMBER")
data class Member (
    @Id
    @Column(name = "ID")
    private val id : String?,

)
----

=== Column 어노테이션에 DDL 조건 추가

[source,kotlin]
----
    @Id
    @Column(name = "ID", nullable = false, length = 16)
    val id : String,
----

== 엔티티 메니저
=== 엔티티 매니저 설정

[source,kotlin]
----
	val emf = Persistence.createEntityManagerFactory("jpaTest")
	val em = emf.createEntityManager()
----

=== 트랜잭션 관리

[source,kotlin]
----
	val tx = em.transaction
	try {
		tx.begin()
		logic(em)
		tx.commit()
	} catch (e: Exception) {
		tx.rollback()
	} finally {
		em.close()
	}
----

=== repository에서 em과 tx 활용

[source, kotlin]
----
class MemoryMemberRepository : MemberRepository {

    override val em: EntityManager
        get() = EntityManagerObject.em
    override val tx: EntityTransaction
        get() = EntityManagerObject.tx

    override fun save(member: Member) {
        tx.begin()
        em.persist(member)
        tx.commit()
    }

    override fun findById(id: String): Member {
        return em.find(Member::class.java, id)
    }

}

----

= ERROR

== Unable to load class [org.h2.Driver] 
h2 사용시 생기는 오류로 build.gradle.kts에 의존성 추가로 해결
```kotlin
	runtimeOnly ("com.h2database:h2")
	testImplementation ("org.springframework.boot:spring-boot-starter-test")
```

== Unable to locate persister
JPA가 자동으로 Entity 클래스를 불러오지 못하는 상황이 생겼다.

여러가지 방법을 시도했지만 안됐고, 해결한 방법은 persistence.xml에 직접 class를 추가해준 것이다.

```xml
    <persistence-unit name="jpaTest">
        <class> com.shan.kopring.data.model.Member</class> //직접 추가한 부분
        <properties>
		'''

persistence.xml
```
